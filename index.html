<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Acordes y Visualizador</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="importmap">
    {
      "imports": {
        "tone": "https://esm.sh/tone@^15.0.4"
      }
    }
    </script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Visualizador y Compositor de Piano</h1>
            <p class="description">Explora progresiones de acordes en un entorno visual, interactivo y sonoro.</p>
        </header>
        
        <nav class="tabs">
            <button id="visualizer-tab" class="tab active">Visualizador</button>
            <button id="composer-tab" class="tab">Compositor</button>
            <button id="extractor-tab" class="tab">Extractor</button>
        </nav>

        <main id="visualizer-mode" class="mode-content active">
            <div class="controls">
                <div class="select-wrapper">
                    <label for="root-note-select">Nota Raíz</label>
                    <select id="root-note-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="chord-type-select">Tipo de Acorde</label>
                    <select id="chord-type-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="visualizer-bass-note-select">Bajo en (Opcional)</label>
                    <select id="visualizer-bass-note-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="visualizer-inversion-select">Inversión</label>
                    <select id="visualizer-inversion-select"></select>
                </div>
            </div>
            <div class="chord-display-header">
                <h2 id="chord-name"></h2>
                <button id="visualizer-play-btn" class="play-btn" aria-label="Reproducir acorde">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor"><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg>
                </button>
            </div>
            <div id="piano-container">
                <div class="piano" aria-label="Piano virtual">
                    <!-- Las teclas del piano serán generadas aquí por TypeScript -->
                </div>
            </div>
        </main>

        <main id="composer-mode" class="mode-content">
            <p class="description" style="max-width: 650px; margin-bottom: 1.5rem;">Haz clic en la letra para insertar un acorde. Arrastra las etiquetas para reordenar.</p>
            
            <div id="composer-controls" class="controls" style="display: none;">
                <div class="select-wrapper">
                    <label for="composer-root-note-select">Nota Raíz</label>
                    <select id="composer-root-note-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="composer-type-select">Tipo de Acorde</label>
                    <select id="composer-type-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="composer-bass-note-select">Bajo en (Opcional)</label>
                    <select id="composer-bass-note-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="composer-inversion-select">Inversión</label>
                    <select id="composer-inversion-select"></select>
                </div>
                <button id="add-to-sequence-btn" class="button-primary">Añadir</button>
            </div>
            <div class="composition-actions">
                <button id="clear-sequence-btn" class="button-secondary">Limpiar Canción</button>
            </div>

            <div id="composition-output">
                <!-- La composición generada se mostrará aquí -->
            </div>

            <div id="chord-insertion-indicator" class="insert-placeholder" style="display: none;">+</div>

        </main>

        <main id="extractor-mode" class="mode-content">
            <p class="description" style="max-width: 650px;">Pega la letra y los acordes de una canción. Haz clic en un acorde para ver su diagrama y escucharlo.</p>
            <textarea id="song-input" placeholder="Pega tu canción aquí... por ejemplo:

      G         D
Sobre todo, poder y rey
     Em        C
Sobre toda, humanidad y ley..."></textarea>
            <div class="controls">
                <button id="process-song-btn" class="button-primary">Analizar Canción</button>
                <button id="add-to-composer-btn" class="button-secondary" disabled>Añadir acordes al Compositor</button>
            </div>
            <div id="extractor-loader" class="loader-container" style="display: none;">
                <div class="spinner"></div>
                <p>Analizando...</p>
            </div>
            <div id="song-output" class="song-sheet-container">
                 <!-- La canción procesada se mostrará aquí -->
            </div>
            <div id="transposition-controls" class="controls" style="display: none; margin-top: 20px;">
                <button id="transpose-down-btn" class="button-secondary">- Semitono</button>
                <span id="transposition-display">Tonalidad Original</span>
                <button id="transpose-up-btn" class="button-secondary">+ Semitono</button>
            </div>
        </main>

        <!-- Chord Inspector Modal -->
        <div id="chord-inspector-overlay"></div>
        <div id="chord-inspector-modal">
            <div class="inspector-header">
                <h3 id="chord-inspector-title"></h3>
                <button id="chord-inspector-play-btn" class="play-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor"><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg>
                </button>
                <button id="chord-inspector-insert-btn" class="button-primary" style="margin-left: 15px;">Insertar</button>
                <button id="chord-inspector-delete-btn" class="button-secondary" style="background-color: #792525; margin-left: 15px;">Eliminar</button>
                <button id="chord-inspector-close-btn">×</button>
            </div>

            <div class="inspector-controls">
                <div class="select-wrapper">
                    <label for="chord-inspector-root-note-select">Nota Raíz</label>
                    <select id="chord-inspector-root-note-select"></select>
                </div>
                <div class="select-wrapper">
                    <label for="chord-inspector-type-select">Tipo de Acorde</label>
                    <select id="chord-inspector-type-select"></select>
                </div>
                
                <!-- === BLOQUE AÑADIDO === -->
                <div class="select-wrapper">
                    <label for="chord-inspector-bass-note-select">Bajo en (Opcional)</label>
                    <select id="chord-inspector-bass-note-select"></select>
                </div>
                <!-- ===================== -->

                <div class="select-wrapper">
                    <label for="chord-inspector-inversion-select">Inversión</label>
                    <select id="chord-inspector-inversion-select"></select>
                </div>
            </div>
            
            <div id="chord-inspector-piano"></div>
        </div>

        <!-- Chord Replacement Modal -->
        <div id="chord-replacement-overlay" class="modal-overlay"></div>


    </div>
    <script type="module" src="index.tsx"></script>
</body>
</html>